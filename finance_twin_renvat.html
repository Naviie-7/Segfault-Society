<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Twin // Willpower Logic V5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --neon-blue: #3b82f6;
            --neon-red: #ef4444;
            --neon-amber: #f59e0b;
            --neon-green: #10b981;
            --glass-bg: rgba(15, 23, 42, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            background-color: #020617;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(16, 185, 129, 0.05) 0%, transparent 25%);
            color: #e2e8f0;
            font-family: 'Space Grotesk', sans-serif;
            overflow-x: hidden;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        @keyframes breathe {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.2); transform: scale(1); }
            50% { box-shadow: 0 0 40px rgba(59, 130, 246, 0.5); transform: scale(1.02); }
        }
        .core-active { animation: breathe 3s infinite ease-in-out; }

        .cyber-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #334155;
            color: white;
            transition: all 0.3s;
        }
        .cyber-input:focus {
            border-color: var(--neon-blue);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.2);
            outline: none;
        }

        .mood-btn {
            opacity: 0.5;
            filter: grayscale(100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
        }
        .mood-btn:hover {
            opacity: 0.8;
            transform: translateY(-2px);
            filter: grayscale(50%);
        }
        .mood-btn.active { 
            opacity: 1; 
            filter: grayscale(0%);
            transform: scale(1.1);
            border-color: var(--neon-blue); 
            background: rgba(59, 130, 246, 0.2);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
            z-index: 10;
        }

        .meter-bg { background: #1e293b; border-radius: 99px; height: 8px; overflow: hidden; }
        .meter-fill { height: 100%; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }

        .fade-in-row { animation: fadeIn 0.5s forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body class="min-h-screen p-4 flex items-center justify-center">

    <!-- LOGIN PAGE -->
    <div id="login-page" class="w-full max-w-md">
        <div class="glass-panel rounded-3xl p-8 relative overflow-hidden">
            <div class="text-center mb-8">
                <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                    <i class="fa-solid fa-fingerprint text-4xl text-white"></i>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">FINANCE TWIN</h1>
                <p class="text-sm text-slate-400">Secure Login to Your Financial Guardian</p>
            </div>

            <div class="flex gap-2 mb-6 p-1 bg-slate-900/50 rounded-xl">
                <button onclick="window.switchLoginMethod('email')" id="email-tab" class="flex-1 py-2.5 rounded-lg text-sm font-bold transition-all bg-blue-600 text-white">
                    <i class="fa-solid fa-envelope mr-2"></i>Email
                </button>
                <button onclick="window.switchLoginMethod('phone')" id="phone-tab" class="flex-1 py-2.5 rounded-lg text-sm font-bold transition-all text-slate-400 hover:text-white">
                    <i class="fa-solid fa-phone mr-2"></i>Phone
                </button>
            </div>

            <div id="email-form" class="space-y-4">
                <div>
                    <label class="text-xs text-slate-400 font-bold uppercase mb-2 block">Email Address</label>
                    <div class="relative">
                        <i class="fa-solid fa-envelope absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"></i>
                        <input type="email" id="email-input" placeholder="your.email@example.com" class="cyber-input rounded-lg px-10 py-3 text-sm w-full">
                    </div>
                </div>
                <div>
                    <label class="text-xs text-slate-400 font-bold uppercase mb-2 block">Password</label>
                    <div class="relative">
                        <i class="fa-solid fa-lock absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"></i>
                        <input type="password" id="email-password" placeholder="Enter your password" class="cyber-input rounded-lg px-10 py-3 text-sm w-full">
                    </div>
                </div>
                <button onclick="window.handleLogin('email')" class="w-full py-3 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-bold rounded-xl transition-all mt-6">
                    <i class="fa-solid fa-arrow-right mr-2"></i>Login with Email
                </button>
            </div>

            <div id="phone-form" class="hidden space-y-4">
                <div>
                    <label class="text-xs text-slate-400 font-bold uppercase mb-2 block">Phone Number</label>
                    <div class="relative">
                        <i class="fa-solid fa-phone absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"></i>
                        <input type="tel" id="phone-input" placeholder="+91 98765 43210" class="cyber-input rounded-lg px-10 py-3 text-sm w-full">
                    </div>
                </div>
                <div>
                    <label class="text-xs text-slate-400 font-bold uppercase mb-2 block">OTP (One-Time Password)</label>
                    <div class="relative">
                        <i class="fa-solid fa-key absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"></i>
                        <input type="text" id="phone-otp" placeholder="Enter 6-digit OTP" maxlength="6" class="cyber-input rounded-lg px-10 py-3 text-sm w-full">
                    </div>
                    <button onclick="window.sendOTP()" class="mt-2 text-xs text-blue-400 hover:text-blue-300 font-bold">
                        <i class="fa-solid fa-paper-plane mr-1"></i>Send OTP
                    </button>
                </div>
                <button onclick="window.handleLogin('phone')" class="w-full py-3 bg-gradient-to-r from-purple-600 to-purple-500 hover:from-purple-500 hover:to-purple-400 text-white font-bold rounded-xl transition-all mt-6">
                    <i class="fa-solid fa-arrow-right mr-2"></i>Login with Phone
                </button>
            </div>

            <div class="mt-6 text-center">
                <p class="text-xs text-slate-500">Don't have an account? <a href="#" class="text-blue-400 hover:text-blue-300 font-bold">Sign Up</a></p>
            </div>

            <div id="login-loading" class="hidden absolute inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center rounded-3xl">
                <div class="text-center">
                    <i class="fa-solid fa-spinner fa-spin text-4xl text-blue-500 mb-3"></i>
                    <p class="text-white font-bold">Authenticating...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- CAMERA OVERLAY -->
    <div id="camera-overlay" class="fixed inset-0 z-50 bg-black/95 hidden flex flex-col items-center justify-center p-4">
        <div class="relative w-full max-w-md bg-slate-900 rounded-2xl overflow-hidden border border-slate-700">
            <video id="video-feed" autoplay playsinline class="w-full h-64 object-cover"></video>
            <canvas id="camera-canvas" class="hidden"></canvas>
            <div class="p-4 flex justify-center gap-4 bg-slate-900">
                <button onclick="closeCamera()" class="px-4 py-2 text-slate-400 border border-slate-700 rounded-full">Cancel</button>
                <button onclick="snapPhoto()" class="px-6 py-2 rounded-full bg-blue-600 text-white font-bold hover:bg-blue-500">Capture</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-6 w-full max-w-7xl">

        <div class="lg:col-span-5 flex flex-col gap-6">
            
            <div class="glass-panel rounded-3xl p-8 relative overflow-hidden min-h-[750px] flex flex-col justify-between">
                <div class="flex justify-between items-center z-10">
                    <div>
                        <h1 class="text-2xl font-bold tracking-tight text-white">FINANCE TWIN</h1>
                        <p class="text-[10px] text-blue-400 font-mono tracking-widest">WILLPOWER LOGIC V5.0</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="window.logout()" class="px-3 py-1.5 bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 rounded-lg text-red-400 text-xs font-bold transition-all" title="Logout">
                            <i class="fa-solid fa-right-from-bracket mr-1"></i>Logout
                        </button>
                        <div id="model-status" class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_10px_#10b981]"></div>
                    </div>
                </div>

                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div id="core-glow" class="w-64 h-64 bg-blue-600 rounded-full blur-[90px] opacity-20 transition-all duration-1000"></div>
                </div>
                <div class="relative z-10 flex flex-col items-center justify-center my-6">
                    <div class="w-32 h-32 rounded-full border border-slate-700 bg-slate-900/80 backdrop-blur-md flex items-center justify-center shadow-2xl core-active" id="core-circle">
                        <i id="core-icon" class="fa-solid fa-fingerprint text-5xl text-slate-500 transition-all duration-500"></i>
                    </div>
                </div>

                <div class="relative z-10 space-y-4 text-center">
                    
                    <div id="verdict-badge" class="hidden inline-block px-4 py-1 rounded-full text-xs font-bold tracking-widest uppercase mb-2"></div>
                    
                    <div id="ai-message" class="text-sm text-slate-300 font-light min-h-[3rem] flex flex-col items-center justify-center px-2">
                        <span>"I am calibrated."</span>
                        <span class="text-xs text-slate-500 mt-1">Upload an image to assess financial impact.</span>
                    </div>

                    <div id="impulse-container" class="hidden text-left space-y-2 mt-4 p-4 bg-slate-800/50 rounded-xl border border-slate-700/50">
                        <div class="flex justify-between text-[10px] uppercase text-slate-400 font-bold">
                            <span>Impulse Level (Behavior)</span>
                            <span id="impulse-val" class="text-white">0%</span>
                        </div>
                        <div class="meter-bg">
                            <div id="impulse-bar" class="meter-fill bg-gradient-to-r from-blue-500 to-purple-500" style="width: 0%"></div>
                        </div>
                        <p class="text-[10px] text-slate-500 text-right italic" id="risk-reason">Based on Mood & Environment</p>
                    </div>

                    <div id="decision-buttons" class="hidden grid-cols-2 gap-3 mt-4 pt-4 border-t border-slate-700/50">
                        <button onclick="handleUserDecision(true)" class="py-3 rounded-xl bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-400 border border-emerald-500/30 text-xs font-bold transition-all">
                            <i class="fa-solid fa-check mr-1"></i> I BOUGHT IT
                        </button>
                        <button onclick="handleUserDecision(false)" class="py-3 rounded-xl bg-slate-700/30 hover:bg-slate-700/50 text-slate-300 border border-slate-600/30 text-xs font-bold transition-all">
                            <i class="fa-solid fa-xmark mr-1"></i> DIDN'T BUY
                        </button>
                    </div>
                    
                    <div class="mt-6 pt-6 border-t border-slate-700/50">
                        <h3 class="text-[10px] uppercase font-bold text-slate-500 tracking-widest mb-3">
                            <i class="fa-solid fa-receipt text-blue-400 mr-2"></i>Transaction Log
                        </h3>
                        <div class="max-h-48 overflow-y-auto bg-slate-900/30 rounded-xl border border-slate-800" id="history-container">
                            <table class="w-full text-left text-xs">
                                <tbody id="history-body" class="text-slate-400">
                                    <tr class="border-b border-slate-800/50">
                                        <td class="p-4 text-center text-slate-600 italic text-[10px]">No transactions recorded.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-7 flex flex-col gap-6">

            <div class="glass-panel rounded-2xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest"><i class="fa-solid fa-wallet text-blue-500 mr-2"></i> Financial Core</h2>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">API Key:</span>
                        <input type="password" id="api-key" placeholder="Paste Gemini API Key" class="cyber-input rounded px-2 py-1 text-[10px] w-40 focus:w-56 text-center">
                        <button onclick="testApiKey()" id="test-api-btn" class="px-2 py-1 bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/30 rounded text-blue-400 text-[10px] font-bold transition-all" title="Test API Key">
                            <i class="fa-solid fa-flask"></i>
                        </button>
                        <div id="api-status" class="w-2 h-2 rounded-full bg-slate-600" title="API Status: Untested"></div>
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div class="p-3 bg-slate-900/50 rounded-lg border border-slate-800">
                        <div class="text-[10px] text-slate-500 uppercase font-bold mb-2">Income</div>
                        <div class="flex items-center justify-center gap-1">
                            <input type="number" id="income-input" value="5000" class="w-20 bg-slate-800 text-center text-emerald-400 font-bold outline-none border border-slate-700 rounded px-2 py-1 text-sm focus:border-emerald-500">
                            <button onclick="updateIncome()" class="w-7 h-7 bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-400 rounded border border-emerald-500/30 flex items-center justify-center transition-all" title="Confirm">
                                <i class="fa-solid fa-check text-xs"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-3 bg-slate-900/50 rounded-lg border border-slate-800">
                        <div class="text-[10px] text-slate-500 uppercase font-bold mb-2">Spent</div>
                        <div class="flex items-center justify-center gap-1">
                            <input type="number" id="spent-input" value="0" class="w-20 bg-slate-800 text-center text-red-400 font-bold outline-none border border-slate-700 rounded px-2 py-1 text-sm focus:border-red-500">
                            <button onclick="updateSpent()" class="w-7 h-7 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded border border-red-500/30 flex items-center justify-center transition-all" title="Confirm">
                                <i class="fa-solid fa-check text-xs"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-3 bg-blue-900/20 rounded-lg border border-blue-500/30 relative overflow-hidden">
                        <div class="text-[10px] text-blue-300 uppercase relative z-10 font-bold mb-2">Balance</div>
                        <div class="flex items-center justify-center gap-1 relative z-10">
                            <input type="number" id="balance-input" value="5000" class="w-20 bg-slate-800 text-center text-blue-400 font-bold outline-none border border-slate-700 rounded px-2 py-1 text-sm focus:border-blue-500">
                            <button onclick="updateBalance()" class="w-7 h-7 bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 rounded border border-blue-500/30 flex items-center justify-center transition-all" title="Confirm">
                                <i class="fa-solid fa-check text-xs"></i>
                            </button>
                        </div>
                        <div class="absolute inset-0 bg-blue-500/10 blur-xl"></div>
                    </div>
                </div>
            </div>

            <!-- WILLPOWER RESERVES PANEL -->
            <div class="glass-panel rounded-2xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest">
                        <i class="fa-solid fa-brain text-purple-500 mr-2"></i> Willpower Reserves
                    </h2>
                    <button onclick="calculateWillpower()" class="px-3 py-1.5 bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/30 rounded-lg text-purple-400 text-[10px] font-bold transition-all">
                        <i class="fa-solid fa-calculator mr-1"></i>CALCULATE
                    </button>
                </div>
                
                <!-- Willpower Score Display -->
                <div class="mb-4 p-4 bg-slate-900/50 rounded-xl border border-slate-800 relative overflow-hidden">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] uppercase font-bold text-slate-400">Current Willpower (W)</span>
                        <span id="willpower-score" class="text-2xl font-bold text-purple-400">--</span>
                    </div>
                    <div class="meter-bg">
                        <div id="willpower-bar" class="meter-fill bg-gradient-to-r from-purple-500 to-pink-500" style="width: 0%"></div>
                    </div>
                    <div id="willpower-status" class="text-[10px] text-slate-500 mt-2 italic">Enter daily data to calculate</div>
                </div>
                
                <!-- Daily Inputs -->
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="text-[10px] text-slate-400 font-bold uppercase mb-1.5 block">
                            <i class="fa-solid fa-bed mr-1"></i>Sleep (hrs)
                        </label>
                        <input type="number" id="sleep-hours" placeholder="7" min="0" max="12" step="0.5" class="cyber-input rounded-lg px-3 py-2 text-sm w-full text-center">
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-400 font-bold uppercase mb-1.5 block">
                            <i class="fa-solid fa-list-check mr-1"></i>Tasks Done / Total
                        </label>
                        <div class="flex gap-1">
                            <input type="number" id="tasks-completed" placeholder="5" min="0" class="cyber-input rounded-lg px-2 py-2 text-sm w-full text-center">
                            <span class="text-slate-500 flex items-center">/</span>
                            <input type="number" id="tasks-total" placeholder="10" min="1" class="cyber-input rounded-lg px-2 py-2 text-sm w-full text-center">
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="text-[10px] text-slate-400 font-bold uppercase mb-1.5 block">
                        <i class="fa-solid fa-burst mr-1"></i>Bad Decisions Today
                    </label>
                    <input type="number" id="bad-decisions" placeholder="0" min="0" class="cyber-input rounded-lg px-3 py-2 text-sm w-full text-center">
                    <p class="text-[9px] text-slate-600 mt-1 italic">Impulse purchases or ignored warnings</p>
                </div>
                
                <!-- Prediction Alert Box -->
                <div id="prediction-alert" class="hidden mt-4 p-4 rounded-xl border animate-pulse">
                    <div class="flex items-start gap-3">
                        <i class="fa-solid fa-triangle-exclamation text-2xl"></i>
                        <div class="flex-1">
                            <div class="text-xs font-bold uppercase mb-1" id="trap-type">Trap Detected</div>
                            <div class="text-sm" id="prediction-message">Loading prediction...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-panel rounded-2xl p-6">
                <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4"><i class="fa-solid fa-sliders text-amber-500 mr-2"></i> Context Parameters</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="text-[10px] text-slate-400 block mb-3 font-bold">EMOTIONAL STATE</label>
                        <div class="grid grid-cols-4 gap-2">
                            <button onclick="setMood('Neutral', this)" class="mood-btn active p-3 rounded-xl bg-slate-800 text-2xl" title="Neutral">üòê</button>
                            <button onclick="setMood('Happy', this)" class="mood-btn p-3 rounded-xl bg-slate-800 text-2xl" title="Optimistic">üòé</button>
                            <button onclick="setMood('Stressed', this)" class="mood-btn p-3 rounded-xl bg-slate-800 text-2xl" title="Stressed">üò´</button>
                            <button onclick="setMood('Impulsive', this)" class="mood-btn p-3 rounded-xl bg-slate-800 text-2xl" title="Impulsive">ü§™</button>
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] text-slate-400 block mb-3 font-bold">CURRENT ENVIRONMENT</label>
                        <div class="relative">
                            <select id="location-select" class="w-full cyber-input p-3 rounded-xl text-sm appearance-none cursor-pointer bg-slate-800">
                                <option value="Home">üè† Home (Safe Zone)</option>
                                <option value="Shopping Mall">üõçÔ∏è Shopping Mall (High Risk)</option>
                                <option value="Online Store">üíª Late Night Online (High Risk)</option>
                                <option value="Social Event">ü•Ç Out with Friends (Peer Pressure)</option>
                            </select>
                            <div class="absolute right-3 top-4 text-slate-500 pointer-events-none"><i class="fa-solid fa-chevron-down"></i></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-panel rounded-2xl p-6 flex flex-col gap-4">
                <div class="grid grid-cols-3 gap-3">
                    <button onclick="openCamera()" class="py-4 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl flex flex-col items-center justify-center gap-1 transition-all group">
                        <i class="fa-solid fa-camera text-xl text-slate-500 group-hover:text-blue-400 transition-colors"></i>
                        <span class="text-[10px] uppercase font-bold text-slate-500 group-hover:text-white">Camera</span>
                    </button>
                    <label class="py-4 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl flex flex-col items-center justify-center gap-1 cursor-pointer transition-all group">
                        <i class="fa-solid fa-upload text-xl text-slate-500 group-hover:text-blue-400 transition-colors"></i>
                        <span class="text-[10px] uppercase font-bold text-slate-500 group-hover:text-white">Upload</span>
                        <input type="file" id="file-upload" accept="image/*" class="hidden" onchange="handleFile(this)">
                    </label>
                    <div class="py-4 bg-gradient-to-br from-blue-600/20 to-purple-600/20 border border-blue-500/30 rounded-xl flex flex-col items-center justify-center gap-1">
                        <i class="fa-solid fa-keyboard text-xl text-blue-400"></i>
                        <span class="text-[10px] uppercase font-bold text-blue-400">Manual</span>
                    </div>
                </div>

                <div class="space-y-3 p-4 bg-slate-900/50 rounded-xl border border-slate-800">
                    <div>
                        <label class="text-[10px] text-slate-400 font-bold uppercase mb-1.5 block tracking-wider">
                            <i class="fa-solid fa-tag mr-1"></i> Product Name
                        </label>
                        <input type="text" id="manual-product" placeholder="e.g., Nike Air Max Shoes" class="cyber-input rounded-lg px-3 py-2.5 text-sm w-full">
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-400 font-bold uppercase mb-1.5 block tracking-wider">
                            <i class="fa-solid fa-indian-rupee-sign mr-1"></i> Price (‚Çπ)
                        </label>
                        <input type="number" id="manual-price" placeholder="e.g., 5000" class="cyber-input rounded-lg px-3 py-2.5 text-sm w-full">
                    </div>
                </div>

                <div id="img-preview-container" class="hidden h-12 flex items-center justify-between px-4 bg-blue-500/10 rounded border border-blue-500/30">
                    <span class="text-xs text-blue-400 font-mono"><i class="fa-solid fa-check mr-2"></i>Image Buffer Loaded</span>
                    <button onclick="clearImage()" class="text-xs text-red-400 hover:text-white uppercase font-bold">Clear</button>
                </div>

                <button onclick="analyze()" id="analyze-btn" class="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold rounded-xl shadow-lg shadow-blue-900/30 uppercase tracking-[0.15em] text-sm flex items-center justify-center gap-3 transition-transform active:scale-95">
                    <i class="fa-solid fa-bolt"></i> ANALYZE FINANCIAL IMPACT
                </button>
            </div>

        </div>
    </div>

    <script>
        // LOGIN FUNCTIONS
        window.switchLoginMethod = function(method) {
            const emailTab = document.getElementById('email-tab');
            const phoneTab = document.getElementById('phone-tab');
            const emailForm = document.getElementById('email-form');
            const phoneForm = document.getElementById('phone-form');
            
            if (method === 'email') {
                emailTab.className = "flex-1 py-2.5 rounded-lg text-sm font-bold transition-all bg-blue-600 text-white";
                phoneTab.className = "flex-1 py-2.5 rounded-lg text-sm font-bold transition-all text-slate-400 hover:text-white";
                emailForm.classList.remove('hidden');
                phoneForm.classList.add('hidden');
            } else {
                phoneTab.className = "flex-1 py-2.5 rounded-lg text-sm font-bold transition-all bg-purple-600 text-white";
                emailTab.className = "flex-1 py-2.5 rounded-lg text-sm font-bold transition-all text-slate-400 hover:text-white";
                phoneForm.classList.remove('hidden');
                emailForm.classList.add('hidden');
            }
        };
        
        window.sendOTP = function() {
            const phoneInput = document.getElementById('phone-input');
            if (!phoneInput.value) {
                alert('Please enter a phone number first');
                return;
            }
            alert('OTP sent to ' + phoneInput.value + '\n\nFor demo: Use any 6-digit code');
        };
        
        window.handleLogin = function(method) {
            const loading = document.getElementById('login-loading');
            loading.classList.remove('hidden');
            
            setTimeout(() => {
                if (method === 'email') {
                    const email = document.getElementById('email-input').value;
                    const password = document.getElementById('email-password').value;
                    
                    if (!email || !password) {
                        alert('Please enter both email and password');
                        loading.classList.add('hidden');
                        return;
                    }
                    
                    if (email.includes('@') && password.length >= 6) {
                        window.loginSuccess();
                    } else {
                        alert('Invalid credentials');
                        loading.classList.add('hidden');
                    }
                    
                } else {
                    const phone = document.getElementById('phone-input').value;
                    const otp = document.getElementById('phone-otp').value;
                    
                    if (!phone || !otp) {
                        alert('Please enter both phone and OTP');
                        loading.classList.add('hidden');
                        return;
                    }
                    
                    if (phone.length >= 10 && otp.length === 6) {
                        window.loginSuccess();
                    } else {
                        alert('Invalid phone or OTP');
                        loading.classList.add('hidden');
                    }
                }
            }, 1500);
        };
        
        window.loginSuccess = function() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('main-app').classList.add('grid');
            sessionStorage.setItem('financeAppLoggedIn', 'true');
            setTimeout(initializeApp, 100);
        }
        
        window.logout = function() {
            sessionStorage.removeItem('financeAppLoggedIn');
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('main-app').classList.remove('grid');
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('email-input').value = '';
            document.getElementById('email-password').value = '';
            document.getElementById('phone-input').value = '';
            document.getElementById('phone-otp').value = '';
        };
        
        window.addEventListener('DOMContentLoaded', function() {
            if (sessionStorage.getItem('financeAppLoggedIn') === 'true') {
                loginSuccess();
            }
        });
        
        function initializeApp() {
            const incomeInput = document.getElementById('income-input');
            const spentInput = document.getElementById('spent-input');
            const balanceInput = document.getElementById('balance-input');
            
            if (incomeInput) {
                incomeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') updateIncome();
                });
            }
            if (spentInput) {
                spentInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') updateSpent();
                });
            }
            if (balanceInput) {
                balanceInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') updateBalance();
                });
                balanceInput.value = state.balance;
                updateBalanceColor();
            }
        }
        
        // CONFIG & STATE
        const CONFIG = { model: "gemini-2.0-flash-exp" };
        
        let state = {
            income: 5000,
            spent: 0,
            balance: 5000,
            mood: 'Neutral', 
            imageData: null,
            pendingItem: null 
        };

        let transactionHistory = [];
        
        let willpowerData = {
            score: null,
            sleepHours: null,
            tasksCompleted: null,
            tasksTotal: null,
            badDecisions: 0,
            lastCalculated: null
        };

        // CORE UI FUNCTIONS
        function updateUI() {
            state.balance = state.income - state.spent;
            document.getElementById('balance-input').value = state.balance;
            updateBalanceColor();
        }

        function updateBalanceColor() {
            const balInput = document.getElementById('balance-input');
            if(state.balance < 0) {
                balInput.className = "w-20 bg-slate-800 text-center text-red-500 font-bold outline-none border border-slate-700 rounded px-2 py-1 text-sm focus:border-red-500";
            } else if(state.balance < 1000) {
                balInput.className = "w-20 bg-slate-800 text-center text-amber-500 font-bold outline-none border border-slate-700 rounded px-2 py-1 text-sm focus:border-amber-500";
            } else {
                balInput.className = "w-20 bg-slate-800 text-center text-blue-400 font-bold outline-none border border-slate-700 rounded px-2 py-1 text-sm focus:border-blue-500";
            }
        }

        function updateIncome() {
            state.income = parseFloat(document.getElementById('income-input').value) || 0;
            updateUI();
            showUpdateFeedback('income-input');
        }

        function updateSpent() {
            state.spent = parseFloat(document.getElementById('spent-input').value) || 0;
            updateUI();
            showUpdateFeedback('spent-input');
        }

        function updateBalance() {
            const newBalance = parseFloat(document.getElementById('balance-input').value) || 0;
            const difference = newBalance - state.balance;
            
            if (difference > 0) {
                state.income += difference;
                document.getElementById('income-input').value = state.income;
            } else if (difference < 0) {
                state.spent += Math.abs(difference);
                document.getElementById('spent-input').value = state.spent;
            }
            
            state.balance = newBalance;
            updateBalanceColor();
            showUpdateFeedback('balance-input');
        }

        function showUpdateFeedback(inputId) {
            const input = document.getElementById(inputId);
            const originalBorder = input.style.borderColor;
            input.style.borderColor = '#10b981';
            setTimeout(() => {
                input.style.borderColor = originalBorder;
            }, 500);
        }

        function setMood(mood, btn) {
            state.mood = mood;
            document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // API KEY TESTING
        async function testApiKey() {
            const key = document.getElementById('api-key').value;
            const btn = document.getElementById('test-api-btn');
            const status = document.getElementById('api-status');
            
            if(!key) {
                alert("Please enter an API key first");
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            status.className = "w-2 h-2 rounded-full bg-amber-500 animate-pulse";
            status.title = "Testing...";
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.model}:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: "Test" }]
                        }]
                    })
                });
                
                if(response.ok) {
                    status.className = "w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_10px_#10b981]";
                    status.title = "API Key Valid ‚úì";
                    setTimeout(() => {
                        alert("‚úì API Key is valid and working!");
                    }, 200);
                } else {
                    throw new Error("Invalid API Key");
                }
            } catch(e) {
                status.className = "w-2 h-2 rounded-full bg-red-500 shadow-[0_0_10px_#ef4444]";
                status.title = "API Key Invalid ‚úó";
                alert("‚úó API Key test failed. Please check your key.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-flask"></i>';
            }
        }
        
        // WILLPOWER RESERVES SYSTEM
        function calculateWillpower() {
            const sleepHours = parseFloat(document.getElementById('sleep-hours').value);
            const tasksCompleted = parseInt(document.getElementById('tasks-completed').value);
            const tasksTotal = parseInt(document.getElementById('tasks-total').value);
            const badDecisions = parseInt(document.getElementById('bad-decisions').value) || 0;
            
            if(isNaN(sleepHours) || isNaN(tasksCompleted) || isNaN(tasksTotal)) {
                alert("Please fill in all daily data fields");
                return;
            }
            
            if(tasksTotal === 0) {
                alert("Total tasks cannot be 0");
                return;
            }
            
            willpowerData.sleepHours = sleepHours;
            willpowerData.tasksCompleted = tasksCompleted;
            willpowerData.tasksTotal = tasksTotal;
            willpowerData.badDecisions = badDecisions;
            willpowerData.lastCalculated = new Date();
            
            // Calculate S (Sleep Factor)
            let S = 100;
            if(sleepHours < 7) {
                const hoursMissing = 7 - sleepHours;
                S = Math.max(0, 100 - (hoursMissing * 15));
            }
            
            // Calculate T_efficiency
            const T_efficiency = (tasksCompleted / tasksTotal) * 100;
            
            // Calculate E_drain
            const E_drain = badDecisions * 10;
            
            // W = (S √ó 0.4) + (T_efficiency √ó 0.4) - (E_drain √ó 0.2)
            const W = Math.max(0, Math.min(100, 
                (S * 0.4) + (T_efficiency * 0.4) - (E_drain * 0.2)
            ));
            
            willpowerData.score = Math.round(W);
            
            displayWillpowerScore(willpowerData.score);
            checkPredictionTraps(willpowerData.score, sleepHours, tasksCompleted, tasksTotal);
        }
        
        function displayWillpowerScore(score) {
            const scoreEl = document.getElementById('willpower-score');
            const barEl = document.getElementById('willpower-bar');
            const statusEl = document.getElementById('willpower-status');
            
            scoreEl.innerText = score;
            
            setTimeout(() => {
                barEl.style.width = `${score}%`;
                
                if(score < 30) {
                    barEl.className = "meter-fill bg-gradient-to-r from-red-500 to-orange-500";
                    statusEl.innerText = "‚ö†Ô∏è CRITICAL - High Risk of Poor Decisions";
                    statusEl.className = "text-[10px] text-red-400 mt-2 font-bold uppercase";
                } else if(score < 60) {
                    barEl.className = "meter-fill bg-gradient-to-r from-amber-400 to-yellow-400";
                    statusEl.innerText = "‚ö° MODERATE - Stay Alert";
                    statusEl.className = "text-[10px] text-amber-400 mt-2 font-bold uppercase";
                } else {
                    barEl.className = "meter-fill bg-gradient-to-r from-purple-500 to-pink-500";
                    statusEl.innerText = "‚úì STRONG - Good Decision-Making Capacity";
                    statusEl.className = "text-[10px] text-emerald-400 mt-2 font-bold uppercase";
                }
            }, 100);
        }
        
        function checkPredictionTraps(W, sleepHours, tasksCompleted, tasksTotal) {
            const currentHour = new Date().getHours();
            const taskCompletionRate = (tasksCompleted / tasksTotal) * 100;
            const pendingTasks = tasksTotal - tasksCompleted;
            
            let trapDetected = null;
            let trapType = "";
            let trapMessage = "";
            
            // TRAP A: The Convenience Tax
            if(sleepHours < 5 && pendingTasks > 7) {
                trapDetected = "A";
                trapType = "Trap A: The Convenience Tax (Ego Depletion)";
                trapMessage = `Your brain is running on ${sleepHours} hours of sleep with ${pendingTasks} pending tasks. You are about to spend ‚Çπ300-500 on food delivery because your willpower is depleted and your brain is too tired to make complex choices.`;
            }
            
            // TRAP B: The Revenge Splurge
            else if(W < 60 && state.spent < (state.income * 0.1) && transactionHistory.length < 2) {
                trapDetected = "B";
                trapType = "Trap B: The Revenge Splurge (Dopamine Seeking)";
                trapMessage = `You've been "good" with money for days, but your willpower is at ${W}%. Your brain feels deprived and is craving a dopamine hit. High risk of impulse shopping tonight to "reward" yourself for a boring/repetitive day.`;
            }
            
            // TRAP C: The Late-Night Loop
            else if(taskCompletionRate < 20 && currentHour >= 21) {
                trapDetected = "C";
                trapType = "Trap C: The Late-Night Loop (Sunk Cost Fallacy)";
                trapMessage = `Only ${Math.round(taskCompletionRate)}% of tasks done and it's ${currentHour}:00. You feel like you "wasted the day" and are about to stay up until 3 AM scrolling social media because you feel guilty about not working today.`;
            }
            
            if(trapDetected) {
                showPredictionAlert(trapType, trapMessage, W);
                
                const apiKey = document.getElementById('api-key').value;
                if(apiKey) {
                    generateAIPrediction(trapDetected, trapMessage, W, apiKey);
                }
            } else {
                hidePredictionAlert();
            }
        }
        
        function showPredictionAlert(type, message, score) {
            const alertBox = document.getElementById('prediction-alert');
            const trapTypeEl = document.getElementById('trap-type');
            const messageEl = document.getElementById('prediction-message');
            
            trapTypeEl.innerText = type;
            messageEl.innerText = message;
            
            if(score < 30) {
                alertBox.className = "mt-4 p-4 rounded-xl border border-red-500/50 bg-red-900/20 animate-pulse";
                trapTypeEl.className = "text-xs font-bold uppercase mb-1 text-red-400";
                messageEl.className = "text-sm text-red-300";
            } else {
                alertBox.className = "mt-4 p-4 rounded-xl border border-amber-500/50 bg-amber-900/20 animate-pulse";
                trapTypeEl.className = "text-xs font-bold uppercase mb-1 text-amber-400";
                messageEl.className = "text-sm text-amber-300";
            }
            
            alertBox.classList.remove('hidden');
        }
        
        function hidePredictionAlert() {
            document.getElementById('prediction-alert').classList.add('hidden');
        }
        
        async function generateAIPrediction(trapType, baseMessage, W, apiKey) {
            const messageEl = document.getElementById('prediction-message');
            messageEl.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Generating personalized warning...';
            
            try {
                const prompt = `You are a brutally honest Financial Guardian AI. 

The user's willpower is at ${W}%. 
Sleep: ${willpowerData.sleepHours} hours
Tasks: ${willpowerData.tasksCompleted}/${willpowerData.tasksTotal} completed
Bad decisions today: ${willpowerData.badDecisions}

TRAP DETECTED: ${trapType}
Base Warning: "${baseMessage}"

Write a SCARY, PERSONAL, SPECIFIC notification (2-3 sentences max) that:
1. Calls out their exact situation
2. Predicts WHAT they're about to do wrong
3. States the EXACT financial consequence (be specific with rupee amounts)

Make it feel like you're reading their mind. Be direct, punchy, and slightly alarming.
Output ONLY the warning text, no preamble.`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.model}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: prompt }]
                        }]
                    })
                });
                
                const data = await response.json();
                const aiWarning = data.candidates[0].content.parts[0].text.trim();
                
                messageEl.innerText = aiWarning;
                
            } catch(e) {
                console.error("AI prediction error:", e);
                messageEl.innerText = baseMessage;
            }
        }

        // HELPER FUNCTIONS
        function calculateImpulseScore(mood, location) {
            let score = 30;
            
            const moodScores = {
                'Calm': 0,
                'Neutral': 10,
                'Happy': 30,
                'Stressed': 35,
                'Anxious': 40
            };
            score += moodScores[mood] || 10;
            
            const locationScores = {
                'Home': 0,
                'Office': 5,
                'Mall': 30,
                'Online Shopping': 25,
                'Social Event': 20
            };
            score += locationScores[location] || 10;
            
            return Math.min(100, Math.max(0, score));
        }
        
        function calculateVerdict(price, balance) {
            if (price > balance) return "DENIED";
            if (price > (balance * 0.5)) return "DENIED";
            return "APPROVED";
        }
        
        function generateMessage(verdict, price, balance) {
            if (verdict === "DENIED") {
                if (price > balance) {
                    return "Insufficient funds! This exceeds your available balance.";
                } else {
                    return `This is ${Math.round((price/balance)*100)}% of your balance - too risky!`;
                }
            } else {
                const percentage = Math.round((price/balance)*100);
                return `Safe purchase. Only ${percentage}% of your balance.`;
            }
        }

        // AI ANALYSIS
        async function analyze() {
            const key = document.getElementById('api-key').value;
            if(!key) { alert("Please enter API Key"); return; }
            
            const manualProduct = document.getElementById('manual-product').value.trim();
            const manualPrice = parseFloat(document.getElementById('manual-price').value);
            
            const hasManualEntry = manualProduct && !isNaN(manualPrice) && manualPrice > 0;
            const hasImage = state.imageData !== null;
            
            if(!hasManualEntry && !hasImage) { 
                alert("Please either upload an image OR enter product name and price manually"); 
                return; 
            }

            const location = document.getElementById('location-select').value;
            
            const btn = document.getElementById('analyze-btn');
            const icon = document.getElementById('core-icon');
            const msg = document.getElementById('ai-message');
            
            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> CALCULATING IMPACT...`;
            icon.className = "fa-solid fa-spinner fa-spin text-5xl text-blue-500";
            msg.innerHTML = `<span class="animate-pulse">Cross-referencing price vs balance...</span>`;
            
            document.getElementById('impulse-container').classList.add('hidden');
            document.getElementById('decision-buttons').classList.add('hidden');
            document.getElementById('verdict-badge').classList.add('hidden');

            try {
                let result;
                
                if(hasManualEntry) {
                    const impulseScore = calculateImpulseScore(state.mood, location);
                    const verdict = calculateVerdict(manualPrice, state.balance);
                    const message = generateMessage(verdict, manualPrice, state.balance);
                    
                    result = {
                        item: manualProduct,
                        price: manualPrice,
                        impulse_score: impulseScore,
                        verdict: verdict,
                        message: message
                    };
                } else {
                    const prompt = `
                        You are a STRICT Financial Guardian AI.
                        
                        USER DATA:
                        - Current Balance: ‚Çπ${state.balance}
                        - Context: ${state.mood} at ${location}

                        YOUR TASK:
                        
                        1. CALCULATE IMPULSE_SCORE (0-100%):
                           Based on Mood + Location.

                        2. DETERMINE VERDICT:
                           - Estimate the price.
                           - If Price > Balance: DENIED
                           - If Price > 50% of Balance: DENIED
                           - Otherwise: APPROVED

                        OUTPUT JSON ONLY:
                        { 
                          "item": "Short Item Name", 
                          "price": number, 
                          "impulse_score": number, 
                          "verdict": "APPROVED" or "DENIED", 
                          "message": "Punchy explanation." 
                        }
                    `;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.model}:generateContent?key=${key}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: prompt },
                                    { inline_data: { mime_type: "image/jpeg", data: state.imageData } }
                                ]
                            }]
                        })
                    });

                    const data = await response.json();
                    const resultText = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
                    result = JSON.parse(resultText);
                }

                state.pendingItem = result;
                renderResult(result);

            } catch (e) {
                console.error(e);
                msg.innerText = "Error: Could not process logic.";
                icon.className = "fa-solid fa-triangle-exclamation text-5xl text-red-500";
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i class="fa-solid fa-bolt"></i> ANALYZE FINANCIAL IMPACT`;
            }
        }

        function renderResult(data) {
            const icon = document.getElementById('core-icon');
            const glow = document.getElementById('core-glow');
            const msg = document.getElementById('ai-message');
            const badge = document.getElementById('verdict-badge');
            const impulseBox = document.getElementById('impulse-container');
            const impulseBar = document.getElementById('impulse-bar');
            const btns = document.getElementById('decision-buttons');

            let color = "bg-emerald-500";
            let textColor = "text-emerald-400";
            let iconClass = "fa-check";

            if (data.verdict === "DENIED") {
                color = "bg-red-600";
                textColor = "text-red-400";
                iconClass = "fa-ban";
            }

            glow.className = `absolute w-64 h-64 rounded-full blur-[100px] opacity-40 transition-all ${color}`;
            icon.className = `fa-solid ${iconClass} text-5xl ${textColor}`;

            badge.innerText = data.verdict;
            badge.className = `inline-block px-4 py-1 rounded-full text-xs font-bold tracking-widest uppercase mb-2 text-white ${color}`;
            badge.classList.remove('hidden');

            msg.innerHTML = `
                <span class="block text-white text-lg font-bold mb-1">${data.item} (~‚Çπ${data.price})</span>
                <span class="text-slate-400 italic">"${data.message}"</span>
            `;

            impulseBox.classList.remove('hidden');
            document.getElementById('impulse-val').innerText = `${data.impulse_score}%`;
            
            setTimeout(() => {
                impulseBar.style.width = `${data.impulse_score}%`;
                if(data.impulse_score > 70) impulseBar.className = "meter-fill bg-gradient-to-r from-red-500 to-orange-500";
                else if(data.impulse_score > 40) impulseBar.className = "meter-fill bg-gradient-to-r from-amber-400 to-yellow-400";
                else impulseBar.className = "meter-fill bg-gradient-to-r from-blue-400 to-emerald-400";
            }, 100);

            btns.classList.remove('hidden');
            btns.classList.add('grid');
        }

        function handleUserDecision(bought) {
            const msg = document.getElementById('ai-message');
            const btns = document.getElementById('decision-buttons');

            if (bought && state.pendingItem) {
                state.spent += state.pendingItem.price;
                
                // Track as bad decision if it was denied
                if(state.pendingItem.verdict === "DENIED") {
                    willpowerData.badDecisions++;
                    document.getElementById('bad-decisions').value = willpowerData.badDecisions;
                }
                
                const newTx = {
                    item: state.pendingItem.item,
                    price: state.pendingItem.price,
                    verdict: state.pendingItem.verdict,
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                };
                transactionHistory.unshift(newTx);
                
                document.getElementById('spent-input').value = state.spent;
                updateUI();
                renderHistory();
                
                if(state.pendingItem.verdict === "DENIED") {
                    msg.innerHTML = `<span class="text-red-400 font-bold uppercase tracking-widest">‚ö†Ô∏è Bad Decision Recorded</span>`;
                } else {
                    msg.innerHTML = `<span class="text-emerald-400 font-bold uppercase tracking-widest">‚úì Transaction Confirmed</span>`;
                }
            
            } else {
                msg.innerHTML = `<span class="text-blue-400 font-bold uppercase tracking-widest">‚úì Wallet Safe. Good Job.</span>`;
            }

            btns.classList.add('hidden');
            btns.classList.remove('grid');
            state.pendingItem = null;
            
            document.getElementById('manual-product').value = '';
            document.getElementById('manual-price').value = '';
        }

        function renderHistory() {
            const tbody = document.getElementById('history-body');
            tbody.innerHTML = '';

            if(transactionHistory.length === 0) {
                tbody.innerHTML = '<tr><td class="p-4 text-center text-slate-600 italic">No transactions recorded.</td></tr>';
                return;
            }

            transactionHistory.forEach(tx => {
                const row = document.createElement('tr');
                row.className = "border-b border-slate-800/50 hover:bg-slate-800/30 transition-colors fade-in-row";
                const statusColor = tx.verdict === "DENIED" ? "text-red-400" : "text-white";
                
                row.innerHTML = `
                    <td class="p-3">
                        <div class="${statusColor} font-bold text-xs">${tx.item}</div>
                        <div class="text-[10px] text-slate-500">${tx.time}</div>
                    </td>
                    <td class="p-3 text-right text-slate-300 font-mono font-bold text-xs">-‚Çπ${tx.price}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // CAMERA & UTILS
        function handleFile(input) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    state.imageData = e.target.result.split(',')[1];
                    document.getElementById('img-preview-container').classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function clearImage() {
            state.imageData = null;
            document.getElementById('file-upload').value = "";
            document.getElementById('img-preview-container').classList.add('hidden');
        }

        async function openCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                document.getElementById('video-feed').srcObject = stream;
                document.getElementById('camera-overlay').classList.remove('hidden');
            } catch(e) { alert("Camera Error: " + e.message); }
        }

        function closeCamera() {
            const video = document.getElementById('video-feed');
            if(video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
            document.getElementById('camera-overlay').classList.add('hidden');
        }

        function snapPhoto() {
            const video = document.getElementById('video-feed');
            const canvas = document.getElementById('camera-canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            state.imageData = canvas.toDataURL('image/jpeg').split(',')[1];
            document.getElementById('img-preview-container').classList.remove('hidden');
            closeCamera();
        }
    </script>
</body>
</html>