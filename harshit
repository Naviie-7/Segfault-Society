'use client';

import { useState, useCallback, useEffect, useRef } from 'react';
import type { LogEntry } from '@/lib/types';
import type { AnalyzePurchaseInput, AnalyzePurchaseOutput } from '@/ai/flows/analyze-purchase';
import { analyzePurchaseAction } from '@/app/actions';
import PageHeader from '@/components/page-header';
import ApiKeyInput from '@/components/api-key-input';
import VerdictDisplay from '@/components/verdict-display';
import ContextSimulator from '@/components/context-simulator';
import ImpulseInterceptor from '@/components/impulse-interceptor';
import DebugLog from '@/components/debug-log';
import { useToast } from '@/hooks/use-toast';
import CameraCapture from '@/components/camera-capture';

const INITIAL_EARNED = 15000;
const INITIAL_SPENT = 5000;

export default function Home() {
  const [apiKey, setApiKey] = useState('');
  const [mood, setMood] = useState('Neutral');
  const [location, setLocation] = useState('Home (Safe Zone)');
  const [budget, setBudget] = useState(INITIAL_EARNED - INITIAL_SPENT);
  const [spentThisMonth, setSpentThisMonth] = useState(INITIAL_SPENT);
  const [earnedThisMonth, setEarnedThisMonth] = useState(INITIAL_EARNED);
  const [previousMonthsData, setPreviousMonthsData] = useState([
    { month: 'Past Month', spent: 4500, earned: 14000 },
    { month: '2 Months Ago', spent: 6000, earned: 12000 },
    { month: '3 Months Ago', spent: 3500, earned: 13000 },
  ]);
  const [logs, setLogs] = useState<LogEntry[]>([]);
  const [analysisState, setAnalysisState] = useState<'idle' | 'loading' | 'success' | 'error'>('idle');
  const [analysisResult, setAnalysisResult] = useState<AnalyzePurchaseOutput | null>(null);
  const [isCameraOpen, setIsCameraOpen] = useState(false);
  const [purchaseConfirmed, setPurchaseConfirmed] = useState(false);

  const { toast } = useToast();
  
  const prevBudgetRef = useRef(budget);

  useEffect(() => {
    // This timeout ensures client-side only execution after hydration
    const timer = setTimeout(() => {
      const timestamp = new Date().toLocaleTimeString([], { hour12: false });
      setLogs([
        { timestamp: timestamp, message: 'System loaded.', type: 'info' },
        { timestamp: timestamp, message: 'Personality: Witty & Lighthearted.', type: 'info' },
      ]);
      // Initialize prevBudgetRef with the initial budget value
      prevBudgetRef.current = budget;
    }, 0);
    return () => clearTimeout(timer);
  }, [budget]);

  const log = useCallback((message: string, type: LogEntry['type'] = 'info') => {
    const timestamp = new Date().toLocaleTimeString([], { hour12: false });
    setLogs((prevLogs) => [...prevLogs, { timestamp, message, type }]);
  }, []);

  const convertToBase64 = (file: File): Promise<string> => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result as string);
      reader.onerror = (error) => reject(error);
    });
  };
  
  const resetAnalysis = () => {
    setAnalysisState('idle');
    setAnalysisResult(null);
    setPurchaseConfirmed(false);
  }
  
  const handleBudgetChange = (newBudget: number) => {
    const oldBudget = prevBudgetRef.current;
    const delta = newBudget - oldBudget;

    if (delta > 0) {
      setEarnedThisMonth(earnedThisMonth + delta);
      log(`Manual income: +₹${delta}. Earned this month updated.`);
    } else if (delta < 0) {
      setSpentThisMonth(spentThisMonth - delta); // -delta because delta is negative
      log(`Manual expense: -₹${-delta}. Spent this month updated.`);
    }
    
    setBudget(newBudget);
    prevBudgetRef.current = newBudget;
  };


  const runAnalysis = async (input: {
    imageFile?: File | null;
    productName?: string;
    price?: number;
  }) => {
    if (!apiKey) {
      log('ERROR: Missing API Key', 'error');
      toast({ title: 'API Key Missing', description: 'Please paste your API Key before analyzing.', variant: 'destructive' });
      return;
    }
    
    resetAnalysis(); // Reset state before new analysis
    
    let analysisInput: Partial<AnalyzePurchaseInput> = {};

    if (input.imageFile) {
        analysisInput.photoDataUri = await convertToBase64(input.imageFile);
    } else if (input.productName && input.price !== undefined) {
        analysisInput.productName = input.productName;
        analysisInput.price = input.price;
    } else {
        log('ERROR: No Input', 'error');
        toast({ title: 'Input Missing', description: 'Please provide an image or a product name and price.', variant: 'destructive' });
        return;
    }


    setAnalysisState('loading');
    log('Initializing Neural Handshake...', 'warn');

    try {
      log('Contacting Gemini Flash Core...', 'info');

      const result = await analyzePurchaseAction({
        ...analysisInput,
        mood,
        location,
        budget,
        apiKey,
      } as AnalyzePurchaseInput);

      setAnalysisResult(result);
      setAnalysisState('success');
      log(`Analysis Success: ${result.verdict}`, 'success');
    } catch (err: any) {
      console.error(err);
      const errorMessage = err.message || 'An unknown error occurred.';
      log(`SYSTEM FAIL: ${errorMessage}`, 'error');
      setAnalysisState('error');
      setAnalysisResult({
        product_name: 'Error',
        estimated_price: 0,
        verdict: 'DENIED',
        roast: errorMessage,
      });
      toast({ title: 'Analysis Failed', description: errorMessage, variant: 'destructive' });
    }
  };

  const handlePhotoTaken = (dataUri: string, file: File) => {
    log("Image captured from camera.");
    setIsCameraOpen(false);
    runAnalysis({ imageFile: file });
  };
  
  const handlePurchaseConfirmation = (didPurchase: boolean) => {
    if (didPurchase && analysisResult) {
      const price = analysisResult.estimated_price;
      const newBudget = budget - price;
      
      handleBudgetChange(newBudget); // Use the centralized budget handler

      log(`Purchase confirmed for ${analysisResult.product_name}. Budget updated.`, 'warn');
      
      if (newBudget <= 0) {
        toast({
          variant: "destructive",
          title: "Budget Depleted!",
          description: `You've spent your entire budget. Time to start saving again!`,
        });
      } else {
        toast({
          title: 'Purchase Recorded',
          description: `Your wallet balance has been updated to ₹${newBudget}.`,
        });
      }

    } else {
        log('Purchase resisted. Good job!', 'info');
    }
    setPurchaseConfirmed(true);
  };

  return (
    <>
      <ApiKeyInput apiKey={apiKey} setApiKey={setApiKey} />
      <main className="max-w-7xl mx-auto mt-4">
        <PageHeader />

        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
          <div className="lg:col-span-4 h-full">
            <VerdictDisplay 
              analysisState={analysisState} 
              result={analysisResult}
              onPurchaseConfirm={handlePurchaseConfirmation}
              purchaseConfirmed={purchaseConfirmed}
            />
          </div>

          <div className="lg:col-span-8 space-y-6">
            <ContextSimulator
              mood={mood}
              setMood={setMood}
              location={location}
              setLocation={setLocation}
              budget={budget}
              onBudgetChange={handleBudgetChange}
              log={log}
              spentThisMonth={spentThisMonth}
              setSpentThisMonth={setSpentThisMonth}
              earnedThisMonth={earnedThisMonth}
              setEarnedThisMonth={setEarnedThisMonth}
              previousMonthsData={previousMonthsData}
            />

            <ImpulseInterceptor
              runAnalysis={runAnalysis}
              analysisState={analysisState}
              log={log}
              onUseCamera={() => setIsCameraOpen(true)}
            />

            <DebugLog logs={logs} />
          </div>
        </div>
        <CameraCapture
          isOpen={isCameraOpen}
          onClose={() => setIsCameraOpen(false)}
          onPhotoTaken={handlePhotoTaken}
        />
      </main>
    </>
  );
}
